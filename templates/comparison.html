{% extends "base.html" %}

{% block content %}
<div class="container mt-5">
    <div class="row">
        <div class="col-md-12">
            <h2 id="topic-title">Loading...</h2>
            <a href="/" class="btn btn-secondary mb-3">‚Üê Back to Dashboard</a>
            
            <!-- Similarity Score Badge -->
            <div class="card mb-4">
                <div class="card-body">
                    <h5>Overall Similarity Score</h5>
                    <div class="progress" style="height: 30px;">
                        <div id="similarity-bar" class="progress-bar" role="progressbar" style="width: 0%">
                            <span id="similarity-percent">0%</span>
                        </div>
                    </div>
                    <small class="text-muted">Based on vector embedding comparison</small>
                </div>
            </div>
            
            <!-- AI Analysis -->
            <div class="card mb-4 border-info">
                <div class="card-header bg-info text-white">
                    <h5>ü§ñ AI Analysis (Cerebras)</h5>
                </div>
                <div class="card-body">
                    <p id="ai-analysis">Loading AI analysis...</p>
                </div>
            </div>
            
            <!-- Discrepancies -->
            <div class="card mb-4 border-danger">
                <div class="card-header bg-danger text-white">
                    <h5>‚ö†Ô∏è Discrepancies Found</h5>
                </div>
                <div class="card-body">
                    <div id="discrepancies-list"></div>
                </div>
            </div>
            
            <!-- Community Note -->
            <div class="card mb-4 border-success">
                <div class="card-header bg-success text-white">
                    <h5>üìù Community Note</h5>
                </div>
                <div class="card-body">
                    <p id="community-note">Generating community note...</p>
                    <button class="btn btn-success" onclick="publishToDKG()">Publish to DKG</button>
                    <span id="dkg-status" class="ms-2"></span>
                </div>
            </div>
            
            <!-- Content Comparison -->
            <div class="row mt-4">
                <div class="col-md-6">
                    <h5>Wikipedia</h5>
                    <div id="wiki-content" class="border p-3" 
                         style="max-height: 300px; overflow-y: auto; background-color: #f0f8ff;">
                    </div>
                </div>
                <div class="col-md-6">
                    <h5>Grokipedia</h5>
                    <div id="grok-content" class="border p-3" 
                         style="max-height: 300px; overflow-y: auto; background-color: #fff0f5;">
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script>
const urlParams = new URLSearchParams(window.location.search);
const topic = urlParams.get('topic') || '{{ topic }}';

let currentData = null;

fetch(`/api/topic/${encodeURIComponent(topic)}`)
    .then(r => {
        if (!r.ok) throw new Error('Topic not found');
        return r.json();
    })
    .then(data => {
        currentData = data;
        document.getElementById('topic-title').textContent = topic;
        
        // Similarity
        const simPercent = Math.round(data.similarity_score * 100);
        document.getElementById('similarity-percent').textContent = simPercent + '%';
        document.getElementById('similarity-bar').style.width = simPercent + '%';
        
        // Color based on similarity
        const bar = document.getElementById('similarity-bar');
        bar.classList.remove('bg-success', 'bg-warning', 'bg-danger');
        if (simPercent >= 80) bar.classList.add('bg-success');
        else if (simPercent >= 60) bar.classList.add('bg-warning');
        else bar.classList.add('bg-danger');
        
        // AI Analysis - format with HTML
        const aiAnalysis = data.ai_analysis || 'No AI analysis available';
        document.getElementById('ai-analysis').innerHTML = formatLLMResponse(aiAnalysis);
        
        // Discrepancies
        if (data.discrepancies && data.discrepancies.length > 0) {
            const html = data.discrepancies.map(d => `
                <div class="alert alert-warning">
                    <strong>${d.type.toUpperCase()}</strong> (${d.severity})
                    <p>${d.description}</p>
                </div>
            `).join('');
            document.getElementById('discrepancies-list').innerHTML = html;
        } else {
            document.getElementById('discrepancies-list').innerHTML = '<p class="text-success">‚úì No discrepancies found!</p>';
        }
        
        // Community Note - format with HTML
        const communityNote = data.community_note || 'Generating note...';
        document.getElementById('community-note').innerHTML = formatLLMResponse(communityNote);
        
        // Content
        document.getElementById('wiki-content').textContent = 
            data.wiki_content?.substring(0, 500) + '...' || 'N/A';
        document.getElementById('grok-content').textContent = 
            data.grok_content?.substring(0, 500) + '...' || 'N/A';
        
        // Show UAL if already published
        if (data.ual) {
            document.getElementById('dkg-status').innerHTML = 
                `<span class="badge bg-success">Published: ${data.ual}</span>`;
        }
    })
    .catch(err => {
        console.error('Failed to load topic:', err);
        document.getElementById('topic-title').textContent = 'Error: Topic not found';
        document.getElementById('ai-analysis').textContent = 'Please run a scan first from the dashboard.';
    });

function publishToDKG() {
    if (!currentData) {
        alert('No data available to publish');
        return;
    }
    
    const statusElem = document.getElementById('dkg-status');
    statusElem.innerHTML = '<span class="spinner-border spinner-border-sm"></span> Publishing...';
    
    fetch('/api/publish-dkg', {
        method: 'POST',
        headers: {'Content-Type': 'application/json'},
        body: JSON.stringify({
            topic: topic,
            discrepancies: currentData.discrepancies,
            similarity_score: currentData.similarity_score,
            ai_analysis: currentData.ai_analysis
        })
    })
    .then(r => r.json())
    .then(data => {
        if (data.success) {
            statusElem.innerHTML = `<span class="badge bg-success">Published: ${data.ual}</span>`;
        } else {
            statusElem.innerHTML = `<span class="badge bg-danger">Failed: ${data.error}</span>`;
        }
    })
    .catch(err => {
        statusElem.innerHTML = `<span class="badge bg-danger">Error: ${err.message}</span>`;
    });
}
</script>
{% endblock %}
